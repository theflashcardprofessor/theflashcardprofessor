<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Flashcard Professor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #f8f9fa;
            --bg-secondary: white;
            --bg-tertiary: #f8f9fa;
            --text-primary: #2c3e50;
            --text-secondary: #6c757d;
            --border-color: #e9ecef;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.15);
        }

        body.dark-mode {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #1f2937;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --border-color: #30363d;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.4);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.5);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.6);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
        }

        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-container {
            background: var(--bg-secondary);
            padding: 50px;
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            max-width: 450px;
            width: 90%;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .login-header p {
            color: var(--text-secondary);
            font-size: 0.95em;
        }

        .login-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-radius: 12px;
            background: var(--bg-tertiary);
            padding: 5px;
        }

        .login-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .login-tab.active {
            background: white;
            color: #667eea;
            box-shadow: var(--shadow-sm);
        }

        body.dark-mode .login-tab.active {
            background: var(--bg-secondary);
            color: #667eea;
        }

        .login-form {
            display: none;
        }

        .login-form.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .error-message {
            background: #fee;
            color: #e74c3c;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.9em;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .success-message {
            background: #d5f4e6;
            color: #27ae60;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.9em;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.15);
            border-radius: 20px;
            margin-left: auto;
        }

        .user-info-name {
            color: white;
            font-weight: 500;
        }

        .logout-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 6px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--bg-secondary);
            min-height: 100vh;
            box-shadow: 0 0 40px rgba(0,0,0,0.08);
            transition: background 0.3s ease;
        }

        .header {
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            color: white;
            padding: 32px 40px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            border-radius: 0 0 24px 24px;
            position: relative;
        }

        body.dark-mode .header {
            background: linear-gradient(135deg, #1f2937 0%, #374151 50%, #4b5563 100%);
            box-shadow: 0 2px 20px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 2em;
            font-weight: 600;
            margin-bottom: 20px;
            color: white;
            letter-spacing: -0.5px;
        }

        .keyboard-help-btn {
            position: absolute;
            top: 32px;
            right: 40px;
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 0.9em;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .keyboard-help-btn:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
        }

        .nav {
            display: flex;
            justify-content: flex-start;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 24px;
        }

        .nav button {
            background: rgba(255,255,255,0.15);
            border: none;
            color: rgba(255,255,255,0.9);
            padding: 12px 24px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s ease;
            border-radius: 20px;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }

        .nav button:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
        }

        .nav button.active {
            background: white;
            color: #0f2027;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .content {
            padding: 40px;
            min-height: 500px;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .view h2 {
            font-size: 1.8em;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border-color);
        }

        /* Folder Structure */
        .folder-tree {
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 20px;
        }

        .folder-item {
            padding: 14px 18px;
            margin: 6px 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.95em;
            border-radius: 16px;
            position: relative;
            box-shadow: var(--shadow-sm);
        }

        .folder-item:hover {
            background: var(--bg-tertiary);
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }

        body.dark-mode .folder-item:hover {
            background: #1f2937;
        }

        .folder-item.selected {
            background: linear-gradient(135deg, #0f202715 0%, #2c536415 100%);
            border-color: #2c5364;
        }

        body.dark-mode .folder-item.selected {
            background: linear-gradient(135deg, #37415120 0%, #4b556330 100%);
            border-color: #4b5563;
        }

        .folder-item-content {
            flex: 1;
        }

        .folder-collapse-icon {
            font-size: 0.8em;
            transition: transform 0.3s ease;
            cursor: pointer;
            padding: 4px;
            user-select: none;
        }

        .folder-collapse-icon.collapsed {
            transform: rotate(-90deg);
        }

        .folder-children {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
        }

        .folder-children.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .folder-item-color {
            width: 24px;
            height: 24px;
            border-radius: 12px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
        }

        .folder-item-actions {
            display: none;
            gap: 6px;
        }

        .folder-item:hover .folder-item-actions {
            display: flex;
        }

        .icon-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            padding: 6px 14px;
            cursor: pointer;
            font-size: 0.85em;
            border-radius: 12px;
            transition: all 0.2s ease;
            font-weight: 500;
            color: var(--text-primary);
        }

        .icon-btn:hover {
            background: var(--border-color);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .icon-btn.delete {
            color: #e74c3c;
            border-color: #fadbd8;
        }

        .icon-btn.delete:hover {
            background: #fee;
            border-color: #e74c3c;
        }

        .folder-indent {
            margin-left: 30px;
        }

        .folder-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 8px;
        }

        /* Add Card Form */
        .add-card-form {
            background: var(--bg-tertiary);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.95em;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-size: 0.95em;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2c5364;
            box-shadow: 0 0 0 3px rgba(44, 83, 100, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        /* Buttons */
        .btn {
            padding: 12px 28px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0f2027 0%, #2c5364 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.85em;
        }

        /* Study View */
        .study-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .deck-selector {
            background: var(--bg-tertiary);
            padding: 24px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .deck-selector h3 {
            margin-bottom: 16px;
            color: var(--text-primary);
            font-size: 1.2em;
        }

        .flashcard {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 24px;
            padding: 60px 40px;
            text-align: center;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
            position: relative;
            transform-style: preserve-3d;
        }

        .flashcard:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .flashcard.flipping {
            animation: flipCard 0.6s ease-in-out;
        }

        @keyframes flipCard {
            0% {
                transform: rotateY(0deg);
            }
            50% {
                transform: rotateY(90deg);
            }
            100% {
                transform: rotateY(0deg);
            }
        }

        /* Different colored cards */
        .flashcard.color-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-color: #667eea; }
        .flashcard.color-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-color: #f093fb; }
        .flashcard.color-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-color: #4facfe; }
        .flashcard.color-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); border-color: #43e97b; }
        .flashcard.color-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-color: #fa709a; }
        .flashcard.color-6 { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); border-color: #30cfd0; }
        .flashcard.color-7 { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); border-color: #a8edea; }
        .flashcard.color-8 { background: linear-gradient(135deg, #ff9a56 0%, #ff6a88 100%); border-color: #ff9a56; }

        .flashcard[class*="color-"] .flashcard-content {
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .flashcard[class*="color-"] .flashcard-side-indicator {
            color: rgba(255,255,255,0.9);
        }

        .flashcard-content {
            font-size: 1.4em;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .flashcard-side-indicator {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 0.9em;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .flashcard-controls {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .progress-bar {
            background: var(--border-color);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0f2027 0%, #2c5364 100%);
            transition: width 0.3s ease;
        }

        /* Test View */
        .test-question {
            background: var(--bg-tertiary);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .test-question h3 {
            margin-bottom: 20px;
            color: var(--text-primary);
            font-size: 1.3em;
        }

        .test-input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1em;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .test-input:focus {
            outline: none;
            border-color: #2c5364;
        }

        .test-results {
            background: var(--bg-tertiary);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
        }

        .result-item {
            padding: 20px;
            margin-bottom: 16px;
            border-radius: 16px;
            background: var(--bg-secondary);
            border-left: 4px solid transparent;
        }

        .result-item.correct {
            border-left-color: #27ae60;
            background: #d5f4e6;
        }

        body.dark-mode .result-item.correct {
            background: #1a3d2e;
        }

        .result-item.incorrect {
            border-left-color: #e74c3c;
            background: #fadbd8;
        }

        body.dark-mode .result-item.incorrect {
            background: #3d1a1a;
        }

        .result-question {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .result-answer {
            color: var(--text-secondary);
            margin: 4px 0;
        }

        /* Stats View */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-tertiary);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }

        .stat-card.stat-color-1::before {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }

        .stat-card.stat-color-2::before {
            background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
        }

        .stat-card.stat-color-3::before {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
        }

        .stat-card.stat-color-4::before {
            background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
        }

        .stat-card.stat-color-5::before {
            background: linear-gradient(90deg, #fa709a 0%, #fee140 100%);
        }

        .stat-card.stat-color-6::before {
            background: linear-gradient(90deg, #30cfd0 0%, #330867 100%);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .stat-value {
            font-size: 3em;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card.stat-color-1 .stat-value {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card.stat-color-2 .stat-value {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card.stat-color-3 .stat-value {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card.stat-color-4 .stat-value {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card.stat-color-5 .stat-value {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card.stat-color-6 .stat-value {
            background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        body.dark-mode .stat-value {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.95em;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Settings */
        .settings-section {
            background: var(--bg-tertiary);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
        }

        .settings-section h3 {
            margin-bottom: 20px;
            color: var(--text-primary);
            font-size: 1.3em;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-weight: 500;
            color: var(--text-primary);
        }

        .setting-description {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .toggle {
            position: relative;
            width: 60px;
            height: 30px;
            background: var(--border-color);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle.active {
            background: #2c5364;
        }

        .toggle-knob {
            position: absolute;
            width: 26px;
            height: 26px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle.active .toggle-knob {
            left: 32px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: var(--bg-secondary);
            margin: 5% auto;
            padding: 40px;
            border-radius: 24px;
            max-width: 600px;
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h2 {
            font-size: 1.6em;
            color: var(--text-primary);
        }

        .close {
            font-size: 2em;
            font-weight: 300;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            line-height: 1;
        }

        .close:hover {
            color: var(--text-primary);
            transform: rotate(90deg);
        }

        .color-picker {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .color-option-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .color-option {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 3px solid transparent;
        }

        .color-option:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .card-manage-item {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }

        .card-manage-content {
            flex: 1;
        }

        .card-manage-content > div {
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .card-manage-content strong {
            color: var(--text-secondary);
        }

        /* Keyboard shortcuts help */
        .shortcuts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .shortcut-key {
            background: var(--bg-secondary);
            padding: 4px 12px;
            border-radius: 6px;
            font-family: monospace;
            font-weight: 600;
            border: 1px solid var(--border-color);
        }

        /* Multi-deck selector */
        .deck-checkbox-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }

        .deck-checkbox-item {
            padding: 12px;
            margin: 6px 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .deck-checkbox-item:hover {
            background: var(--bg-tertiary);
            transform: translateX(4px);
        }

        .deck-checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .deck-info {
            flex: 1;
        }

        .deck-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .deck-path {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .deck-card-count {
            font-size: 0.85em;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            padding: 4px 12px;
            border-radius: 12px;
        }

        .folder-group {
            margin-bottom: 16px;
        }

        .folder-group-header {
            font-weight: 600;
            color: var(--text-primary);
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .selection-summary {
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: 12px;
            margin-top: 16px;
            text-align: center;
            font-weight: 500;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: 24px 20px;
            }

            .content {
                padding: 20px;
            }

            .flashcard {
                padding: 40px 20px;
                min-height: 250px;
            }

            .flashcard-content {
                font-size: 1.1em;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 10% 20px;
                padding: 24px;
            }

            .keyboard-help-btn {
                position: relative;
                top: 0;
                right: 0;
                margin-bottom: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <div class="login-header">
                <h1>üéì The Flashcard Professor</h1>
                <p>Your personal learning companion</p>
            </div>

            <div class="login-tabs">
                <button class="login-tab active" onclick="switchLoginTab('login')">Login</button>
                <button class="login-tab" onclick="switchLoginTab('signup')">Sign Up</button>
            </div>

            <div id="errorMessage" class="error-message"></div>
            <div id="successMessage" class="success-message"></div>

            <!-- Login Form -->
            <div id="loginForm" class="login-form active">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" placeholder="your@email.com" autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" autocomplete="current-password">
                </div>
                
                <div style="text-align: right; margin-bottom: 16px;">
                    <a href="#" onclick="openModal('forgotPasswordModal'); return false;" style="color: #667eea; text-decoration: none; font-size: 0.9em;">Forgot password?</a>
                </div>
                
                <button class="btn btn-primary" style="width: 100%;" onclick="handleLogin()">Login</button>
                
                <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                    <p style="color: var(--text-secondary); font-size: 0.9em; margin-bottom: 12px;">Don't want to create an account?</p>
                    <button class="btn btn-secondary" style="width: 100%;" onclick="continueAsGuest()">Continue as Guest</button>
                    <p style="color: var(--text-secondary); font-size: 0.8em; margin-top: 8px;">‚ö†Ô∏è Your flashcards won't be saved</p>
                </div>
            </div>

            <!-- Signup Form -->
            <div id="signupForm" class="login-form">
                <div class="form-group">
                    <label for="signupName">Name</label>
                    <input type="text" id="signupName" placeholder="Your name" autocomplete="name">
                </div>
                <div class="form-group">
                    <label for="signupEmail">Email</label>
                    <input type="email" id="signupEmail" placeholder="your@email.com" autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" placeholder="Create a password" autocomplete="new-password">
                </div>
                <div class="form-group">
                    <label for="signupPasswordConfirm">Confirm Password</label>
                    <input type="password" id="signupPasswordConfirm" placeholder="Confirm your password" autocomplete="new-password">
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="handleSignup()">Sign Up</button>
            </div>
        </div>
    </div>

    <div class="container" id="mainApp" style="display: none;">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <h1>üéì The Flashcard Professor</h1>
                </div>
                <div class="user-info">
                    <span class="user-info-name" id="userName"></span>
                    <button class="logout-btn" onclick="handleLogout()">Logout</button>
                </div>
            </div>
            <div class="nav">
                <button onclick="showView('home')" class="active" data-view="home">üè† Home</button>
                <button onclick="showView('study')" data-view="study">üìñ Study</button>
                <button onclick="showView('test')" data-view="test">‚úèÔ∏è Test</button>
                <button onclick="showView('stats')" data-view="stats">üìä Stats</button>
                <button onclick="showView('settings')" data-view="settings">‚öôÔ∏è Settings</button>
            </div>
        </div>

        <div class="content">
            <!-- Home View -->
            <div id="homeView" class="view active">
                <h2>üè† Home</h2>
                
                <!-- Add Cards Section -->
                <div style="margin-bottom: 30px;">
                    <button class="btn btn-primary" onclick="toggleAddCardForm()" id="addCardToggleBtn">
                        ‚ûï Add New Card
                    </button>
                </div>
                
                <div class="add-card-form" id="addCardForm" style="display: none; margin-bottom: 40px;">
                    <h3 style="margin-bottom: 20px; font-size: 1.3em;">‚ûï Add New Cards</h3>
                    <div class="form-group">
                        <label for="cardDeck">Select Deck *</label>
                        <select id="cardDeck" required></select>
                    </div>
                    <div class="form-group">
                        <label for="cardFront">Question / Front *</label>
                        <textarea id="cardFront" placeholder="Enter the question or front of card" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="cardBack">Answer / Back *</label>
                        <textarea id="cardBack" placeholder="Enter the answer or back of card" required></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="addCard()">Add Card</button>
                    <button class="btn btn-secondary" onclick="clearCardForm()">Clear</button>
                    <button class="btn btn-secondary" onclick="toggleAddCardForm()">Cancel</button>
                </div>

                <!-- Library Section -->
                <h3 style="margin-bottom: 20px; font-size: 1.3em;">üìö My Library</h3>
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="openModal('folderModal')">New Folder</button>
                    <button class="btn btn-primary" onclick="openModal('deckModal')">New Deck</button>
                </div>
                <div id="folderTree" class="folder-tree"></div>
            </div>

            <!-- Study View -->
            <div id="studyView" class="view">
                <h2>üìñ Study Mode</h2>
                <div class="study-container">
                    <div class="deck-selector">
                        <h3>Select decks to study</h3>
                        <button class="btn btn-primary" onclick="openStudyDeckSelector()">Select Decks</button>
                        <div id="selectedStudyDecksInfo" style="margin-top: 16px; color: var(--text-secondary);"></div>
                    </div>
                    <div id="studyArea" style="display: none;">
                        <div class="progress-bar">
                            <div id="studyProgress" class="progress-fill" style="width: 0%"></div>
                        </div>
                        <div id="flashcard" class="flashcard" onclick="flipCard()">
                            <div class="flashcard-side-indicator" id="sideIndicator">Front</div>
                            <div id="flashcardContent" class="flashcard-content"></div>
                        </div>
                        <div class="flashcard-controls">
                            <button class="btn btn-secondary" onclick="prevCard()">‚Üê Previous</button>
                            <button class="btn btn-primary" onclick="flipCard()">Flip Card</button>
                            <button class="btn btn-secondary" onclick="nextCard()">Next ‚Üí</button>
                            <button class="btn btn-danger" onclick="endStudy()">End Session</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test View -->
            <div id="testView" class="view">
                <h2>‚úèÔ∏è Test Mode</h2>
                <div class="study-container">
                    <div class="deck-selector">
                        <h3>Select decks to test</h3>
                        <button class="btn btn-primary" onclick="openDeckSelector()">Select Decks</button>
                        <div id="selectedDecksInfo" style="margin-top: 16px; color: var(--text-secondary);"></div>
                    </div>
                    <div id="testArea" style="display: none;"></div>
                    <div id="testResults" style="display: none;"></div>
                </div>
            </div>

            <!-- Stats View -->
            <div id="statsView" class="view">
                <h2>üìä Your Statistics</h2>
                <div class="stats-grid" id="statsGrid"></div>
                
                <div class="settings-section" style="margin-top: 30px;">
                    <h3>Recent Activity</h3>
                    <div id="recentActivity"></div>
                </div>
                
                <div class="settings-section">
                    <h3>Performance Breakdown</h3>
                    <div id="performanceBreakdown"></div>
                </div>
                
                <div class="settings-section">
                    <h3>Study Streaks</h3>
                    <div id="studyStreaks"></div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settingsView" class="view">
                <h2>‚öôÔ∏è Settings</h2>
                
                <div id="guestWarningBanner" style="display: none; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: var(--shadow-md);">
                    <h3 style="margin-bottom: 12px; color: white;">‚ö†Ô∏è Guest Mode Active</h3>
                    <p style="margin-bottom: 12px; line-height: 1.5;">You're using guest mode. Your flashcards will be deleted when you close this tab/browser.</p>
                    <p style="font-weight: 600; margin-bottom: 16px;">üí° Export your data below to save it, or create an account to save permanently!</p>
                    <button class="btn" style="background: white; color: #f5576c; font-weight: 600;" onclick="switchLoginTab('signup'); showView('home'); setTimeout(() => handleLogout(), 100)">Create Account Now</button>
                </div>
                
                <div class="settings-section">
                    <h3>Help</h3>
                    <button class="btn btn-primary" onclick="openModal('keyboardModal')" style="width: 100%;">‚å®Ô∏è View Keyboard Shortcuts</button>
                </div>

                <div class="settings-section">
                    <h3>Study Settings</h3>
                    <div class="setting-item">
                        <div>
                            <div class="setting-label">Shuffle Cards</div>
                            <div class="setting-description">Randomize card order when studying</div>
                        </div>
                        <div class="toggle" id="shuffleToggle" onclick="toggleSetting('shuffle')">
                            <div class="toggle-knob"></div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <div>
                            <div class="setting-label">Show Answer in Test</div>
                            <div class="setting-description">Display correct answer after each question</div>
                        </div>
                        <div class="toggle" id="showAnswerToggle" onclick="toggleSetting('showAnswer')">
                            <div class="toggle-knob"></div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Test Settings</h3>
                    <div class="form-group">
                        <label for="testLimitInput">Questions per Test</label>
                        <input type="number" id="testLimitInput" min="5" max="100" value="20" onchange="updateTestLimit(this.value)">
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Appearance</h3>
                    <div class="setting-item">
                        <div>
                            <div class="setting-label">Dark Mode</div>
                            <div class="setting-description">Switch to dark theme</div>
                        </div>
                        <div class="toggle" id="themeToggle" onclick="toggleTheme()">
                            <div class="toggle-knob"></div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Data Management</h3>
                    <button class="btn btn-primary" onclick="exportData()">Export Data</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Import Data</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                    <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Guest Warning Modal -->
    <div id="guestWarningModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <h2 style="color: #e74c3c;">‚ö†Ô∏è Guest Mode Warning</h2>
                <span class="close" onclick="closeModal('guestWarningModal')">&times;</span>
            </div>
            
            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="color: white; margin-bottom: 12px; font-size: 1.2em;">You are about to continue without an account</h3>
                <p style="line-height: 1.6;">This means your flashcards will NOT be saved permanently and will be lost when you close your browser.</p>
            </div>
            
            <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h4 style="color: var(--text-primary); margin-bottom: 16px;">‚ö†Ô∏è Important Limitations:</h4>
                <ul style="list-style: none; padding: 0;">
                    <li style="padding: 8px 0; display: flex; align-items: start; gap: 12px;">
                        <span style="color: #e74c3c; font-size: 1.2em;">‚úó</span>
                        <span style="color: var(--text-primary);">Your flashcards will <strong>NOT be saved permanently</strong></span>
                    </li>
                    <li style="padding: 8px 0; display: flex; align-items: start; gap: 12px;">
                        <span style="color: #e74c3c; font-size: 1.2em;">‚úó</span>
                        <span style="color: var(--text-primary);">All data will be <strong>lost when you close this tab/browser</strong></span>
                    </li>
                    <li style="padding: 8px 0; display: flex; align-items: start; gap: 12px;">
                        <span style="color: #e74c3c; font-size: 1.2em;">‚úó</span>
                        <span style="color: var(--text-primary);">You <strong>cannot sync across devices</strong></span>
                    </li>
                </ul>
            </div>
            
            <div style="background: #d5f4e6; color: #27ae60; padding: 16px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #27ae60;">
                <strong>üí° Recommendation:</strong> Create a free account to save your flashcards permanently!
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button class="btn btn-secondary" style="flex: 1;" onclick="closeModal('guestWarningModal')">Go Back</button>
                <button class="btn" style="flex: 1; background: #e74c3c; color: white;" onclick="confirmGuestMode()">Continue as Guest</button>
            </div>
        </div>
    </div>

    <!-- Guest Logout Warning Modal -->
    <div id="guestLogoutModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 style="color: #e74c3c;">‚ö†Ô∏è Logout Warning</h2>
                <span class="close" onclick="closeModal('guestLogoutModal')">&times;</span>
            </div>
            
            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 24px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                <div style="font-size: 3em; margin-bottom: 12px;">üóëÔ∏è</div>
                <h3 style="color: white; margin-bottom: 12px; font-size: 1.3em;">All Your Flashcards Will Be Deleted!</h3>
                <p style="line-height: 1.6; font-size: 1.05em;">As a guest, logging out will permanently delete all your flashcards and progress.</p>
            </div>
            
            <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h4 style="color: var(--text-primary); margin-bottom: 12px;">üíæ Want to save your work?</h4>
                <p style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 16px;">Go to Settings and export your data before logging out, or create an account to save permanently.</p>
                <button class="btn btn-primary" style="width: 100%;" onclick="closeModal('guestLogoutModal'); showView('settings');">Go to Settings</button>
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button class="btn btn-secondary" style="flex: 1;" onclick="closeModal('guestLogoutModal')">Cancel</button>
                <button class="btn btn-danger" style="flex: 1;" onclick="performLogout()">Delete & Logout</button>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgotPasswordModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <h2 style="color: #667eea;">üîê Forgot Password</h2>
                <span class="close" onclick="closeModal('forgotPasswordModal')">&times;</span>
            </div>
            
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="color: white; margin-bottom: 12px; font-size: 1.2em;">Password Recovery Not Available</h3>
                <p style="line-height: 1.6;">We don't currently have password reset functionality since all data is stored locally in your browser.</p>
            </div>
            
            <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h4 style="color: var(--text-primary); margin-bottom: 16px;">üìã Your Options:</h4>
                <ul style="list-style: none; padding: 0;">
                    <li style="padding: 12px 0; display: flex; align-items: start; gap: 12px; border-bottom: 1px solid var(--border-color);">
                        <span style="font-size: 1.3em;">1Ô∏è‚É£</span>
                        <div>
                            <strong style="color: var(--text-primary); display: block; margin-bottom: 4px;">Delete Your Account</strong>
                            <span style="color: var(--text-secondary); font-size: 0.9em;">Delete your existing account and create a new one</span>
                        </div>
                    </li>
                    <li style="padding: 12px 0; display: flex; align-items: start; gap: 12px;">
                        <span style="font-size: 1.3em;">2Ô∏è‚É£</span>
                        <div>
                            <strong style="color: var(--text-primary); display: block; margin-bottom: 4px;">Continue as Guest</strong>
                            <span style="color: var(--text-secondary); font-size: 0.9em;">Use the app temporarily without an account</span>
                        </div>
                    </li>
                </ul>
            </div>
            
            <div style="background: #fff3cd; color: #856404; padding: 16px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                <strong>‚ö†Ô∏è Warning:</strong> Deleting your account will permanently erase all your flashcards and data!
            </div>
            
            <div class="form-group">
                <label for="forgotPasswordEmail">Enter your email to delete account:</label>
                <input type="email" id="forgotPasswordEmail" placeholder="your@email.com">
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button class="btn btn-secondary" style="flex: 1;" onclick="closeModal('forgotPasswordModal')">Cancel</button>
                <button class="btn btn-danger" style="flex: 1;" onclick="deleteAccount()">Delete Account</button>
            </div>
        </div>
    </div>

    <!-- Reusable Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="confirmModalTitle">Confirm Action</h2>
                <span class="close" onclick="closeModal('confirmModal')">&times;</span>
            </div>
            
            <div id="confirmModalIcon" style="text-align: center; font-size: 4em; margin-bottom: 16px;">‚ö†Ô∏è</div>
            
            <div id="confirmModalMessage" style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin-bottom: 20px; line-height: 1.6; color: var(--text-primary);"></div>
            
            <div id="confirmModalDetails" style="display: none; background: #fff3cd; color: #856404; padding: 16px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #ffc107;"></div>
            
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-secondary" style="flex: 1;" onclick="closeModal('confirmModal')">Cancel</button>
                <button id="confirmModalBtn" class="btn btn-danger" style="flex: 1;" onclick="">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Folder Modal -->
    <div id="folderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Folder</h2>
                <span class="close" onclick="closeModal('folderModal')">&times;</span>
            </div>
            <div class="form-group">
                <label for="folderName">Folder Name</label>
                <input type="text" id="folderName" placeholder="e.g., Biology, History">
            </div>
            <div class="form-group">
                <label for="folderParent">Parent Folder</label>
                <select id="folderParent">
                    <option value="">Root</option>
                </select>
            </div>
            <div class="form-group">
                <label>Folder Color</label>
                <div class="color-picker">
                    <div class="color-option-container">
                        <input type="radio" name="folderColor" value="#3498db" checked style="display:none;">
                        <div class="color-option" style="background: #3498db;" onclick="this.previousElementSibling.checked = true"></div>
                    </div>
                    <div class="color-option-container">
                        <input type="radio" name="folderColor" value="#e74c3c" style="display:none;">
                        <div class="color-option" style="background: #e74c3c;" onclick="this.previousElementSibling.checked = true"></div>
                    </div>
                    <div class="color-option-container">
                        <input type="radio" name="folderColor" value="#2ecc71" style="display:none;">
                        <div class="color-option" style="background: #2ecc71;" onclick="this.previousElementSibling.checked = true"></div>
                    </div>
                    <div class="color-option-container">
                        <input type="radio" name="folderColor" value="#f39c12" style="display:none;">
                        <div class="color-option" style="background: #f39c12;" onclick="this.previousElementSibling.checked = true"></div>
                    </div>
                    <div class="color-option-container">
                        <input type="radio" name="folderColor" value="#9b59b6" style="display:none;">
                        <div class="color-option" style="background: #9b59b6;" onclick="this.previousElementSibling.checked = true"></div>
                    </div>
                    <div class="color-option-container">
                        <input type="radio" name="folderColor" value="#1abc9c" style="display:none;">
                        <div class="color-option" style="background: #1abc9c;" onclick="this.previousElementSibling.checked = true"></div>
                    </div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="createFolder()">Create Folder</button>
        </div>
    </div>

    <!-- Deck Modal -->
    <div id="deckModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Deck</h2>
                <span class="close" onclick="closeModal('deckModal')">&times;</span>
            </div>
            <div class="form-group">
                <label for="deckName">Deck Name</label>
                <input type="text" id="deckName" placeholder="e.g., Chapter 1 Vocabulary">
            </div>
            <div class="form-group">
                <label for="deckFolder">Folder</label>
                <select id="deckFolder">
                    <option value="">Root</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="createDeck()">Create Deck</button>
        </div>
    </div>

    <!-- Manage Cards Modal -->
    <div id="manageCardsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Manage Cards</h2>
                <span class="close" onclick="closeModal('manageCardsModal')">&times;</span>
            </div>
            <div id="manageCardsList"></div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="keyboardModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚å®Ô∏è Keyboard Shortcuts</h2>
                <span class="close" onclick="closeModal('keyboardModal')">&times;</span>
            </div>
            <h3 style="margin-top: 20px; margin-bottom: 12px;">Navigation</h3>
            <div class="shortcuts-grid">
                <div class="shortcut-item">
                    <span>Home</span>
                    <span class="shortcut-key">1</span>
                </div>
                <div class="shortcut-item">
                    <span>Study</span>
                    <span class="shortcut-key">2</span>
                </div>
                <div class="shortcut-item">
                    <span>Test</span>
                    <span class="shortcut-key">3</span>
                </div>
                <div class="shortcut-item">
                    <span>Stats</span>
                    <span class="shortcut-key">4</span>
                </div>
                <div class="shortcut-item">
                    <span>Settings</span>
                    <span class="shortcut-key">5</span>
                </div>
            </div>
            <h3 style="margin-top: 20px; margin-bottom: 12px;">Study Mode</h3>
            <div class="shortcuts-grid">
                <div class="shortcut-item">
                    <span>Flip Card</span>
                    <span class="shortcut-key">Space</span>
                </div>
                <div class="shortcut-item">
                    <span>Next Card</span>
                    <span class="shortcut-key">‚Üí or D</span>
                </div>
                <div class="shortcut-item">
                    <span>Previous Card</span>
                    <span class="shortcut-key">‚Üê or A</span>
                </div>
                <div class="shortcut-item">
                    <span>End Session</span>
                    <span class="shortcut-key">Esc</span>
                </div>
            </div>
            <h3 style="margin-top: 20px; margin-bottom: 12px;">General</h3>
            <div class="shortcuts-grid">
                <div class="shortcut-item">
                    <span>Show Shortcuts</span>
                    <span class="shortcut-key">?</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Deck Selector Modal -->
    <div id="deckSelectorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Select Decks for Test</h2>
                <span class="close" onclick="closeModal('deckSelectorModal')">&times;</span>
            </div>
            <div id="deckCheckboxList" class="deck-checkbox-list"></div>
            <div class="selection-summary" id="selectionSummary">No decks selected</div>
            <button class="btn btn-primary" style="margin-top: 16px;" onclick="startTestWithSelectedDecks()">Start Test</button>
        </div>
    </div>

    <!-- Study Deck Selector Modal -->
    <div id="studyDeckSelectorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Select Decks to Study</h2>
                <span class="close" onclick="closeModal('studyDeckSelectorModal')">&times;</span>
            </div>
            <div id="studyDeckCheckboxList" class="deck-checkbox-list"></div>
            <div class="selection-summary" id="studySelectionSummary">No decks selected</div>
            <button class="btn btn-primary" style="margin-top: 16px;" onclick="startStudyWithSelectedDecks()">Start Study</button>
        </div>
    </div>

    <!-- Folder Contents Modal -->
    <div id="folderContentsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="folderContentsTitle">Folder Contents</h2>
                <span class="close" onclick="closeModal('folderContentsModal')">&times;</span>
            </div>
            <div id="folderContentsList"></div>
        </div>
    </div>

    <script>
        // Global state
        let appData = {
            folders: [],
            decks: [],
            cards: [],
            stats: {
                totalStudySessions: 0,
                totalTestSessions: 0,
                totalCardsStudied: 0,
                correctAnswers: 0,
                incorrectAnswers: 0
            },
            settings: {
                autoFlip: false,
                shuffle: true,
                sound: false,
                showAnswer: false,
                testLimit: 20,
                theme: 'light',
                compactMode: false,
                animations: true
            }
        };

        let currentView = 'home';
        let currentDeck = null;
        let studyCards = [];
        let currentCardIndex = 0;
        let isFlipped = false;
        let testQuestions = [];
        let testAnswers = {};
        let selectedTestDeckIds = [];
        let selectedStudyDeckIds = [];
        let collapsedFolders = {};
        let currentUser = null;

        // Authentication System
        function initAuth() {
            // Check if user is logged in
            const userSession = localStorage.getItem('flashcardUserSession');
            const guestSession = sessionStorage.getItem('flashcardGuestSession');
            
            if (userSession) {
                currentUser = JSON.parse(userSession);
                showMainApp();
            } else if (guestSession) {
                currentUser = JSON.parse(guestSession);
                showMainApp();
            } else {
                showLoginScreen();
            }
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            // Update user name display
            const userNameEl = document.getElementById('userName');
            if (currentUser.isGuest) {
                userNameEl.innerHTML = `${currentUser.name} <span style="background: #e74c3c; padding: 2px 8px; border-radius: 8px; font-size: 0.75em; margin-left: 4px;">UNSAVED</span>`;
            } else {
                userNameEl.textContent = currentUser.name;
            }
            
            initApp();
        }

        function switchLoginTab(tab) {
            document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.login-form').forEach(f => f.classList.remove('active'));
            
            if (tab === 'login') {
                document.querySelector('.login-tab:first-child').classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else {
                document.querySelector('.login-tab:last-child').classList.add('active');
                document.getElementById('signupForm').classList.add('active');
            }
            
            hideMessages();
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            setTimeout(() => errorEl.classList.remove('show'), 5000);
        }

        function showSuccess(message) {
            const successEl = document.getElementById('successMessage');
            successEl.textContent = message;
            successEl.classList.add('show');
            setTimeout(() => successEl.classList.remove('show'), 3000);
        }

        function hideMessages() {
            document.getElementById('errorMessage').classList.remove('show');
            document.getElementById('successMessage').classList.remove('show');
        }

        function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showError('Please fill in all fields');
                return;
            }

            // Get users from localStorage
            const users = JSON.parse(localStorage.getItem('flashcardUsers') || '{}');
            const user = users[email];

            if (!user) {
                showError('Account not found. Please sign up first.');
                return;
            }

            if (user.password !== password) {
                showError('Incorrect password');
                return;
            }

            // Login successful
            currentUser = { email: user.email, name: user.name };
            localStorage.setItem('flashcardUserSession', JSON.stringify(currentUser));
            showMainApp();
        }

        function handleSignup() {
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupPasswordConfirm').value;

            if (!name || !email || !password || !confirmPassword) {
                showError('Please fill in all fields');
                return;
            }

            if (password.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }

            if (password !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }

            // Check if user already exists
            const users = JSON.parse(localStorage.getItem('flashcardUsers') || '{}');
            
            if (users[email]) {
                showError('An account with this email already exists');
                return;
            }

            // Create new user
            users[email] = {
                name: name,
                email: email,
                password: password,
                createdAt: new Date().toISOString()
            };

            localStorage.setItem('flashcardUsers', JSON.stringify(users));
            
            // Initialize empty data for new user
            const userData = {
                folders: [],
                decks: [],
                cards: [],
                stats: {
                    totalStudySessions: 0,
                    totalTestSessions: 0,
                    totalCardsStudied: 0,
                    correctAnswers: 0,
                    incorrectAnswers: 0
                },
                settings: {
                    autoFlip: false,
                    shuffle: true,
                    sound: false,
                    showAnswer: false,
                    testLimit: 20,
                    theme: 'light',
                    compactMode: false,
                    animations: true
                }
            };
            localStorage.setItem('flashcardApp_' + email, JSON.stringify(userData));

            showSuccess('Account created successfully! You can now login.');
            
            // Clear form
            document.getElementById('signupName').value = '';
            document.getElementById('signupEmail').value = '';
            document.getElementById('signupPassword').value = '';
            document.getElementById('signupPasswordConfirm').value = '';
            
            // Switch to login tab after 2 seconds
            setTimeout(() => {
                switchLoginTab('login');
                document.getElementById('loginEmail').value = email;
            }, 2000);
        }

        function showConfirm(options) {
            // options: { title, message, details, icon, confirmText, confirmClass, onConfirm }
            document.getElementById('confirmModalTitle').textContent = options.title || 'Confirm Action';
            document.getElementById('confirmModalIcon').textContent = options.icon || '‚ö†Ô∏è';
            document.getElementById('confirmModalMessage').innerHTML = options.message || 'Are you sure?';
            
            const detailsEl = document.getElementById('confirmModalDetails');
            if (options.details) {
                detailsEl.innerHTML = options.details;
                detailsEl.style.display = 'block';
            } else {
                detailsEl.style.display = 'none';
            }
            
            const confirmBtn = document.getElementById('confirmModalBtn');
            confirmBtn.textContent = options.confirmText || 'Confirm';
            confirmBtn.className = 'btn ' + (options.confirmClass || 'btn-danger');
            confirmBtn.onclick = function() {
                closeModal('confirmModal');
                if (options.onConfirm) options.onConfirm();
            };
            
            openModal('confirmModal');
        }

        function handleLogout() {
            const isGuest = currentUser && currentUser.isGuest;
            
            if (isGuest) {
                openModal('guestLogoutModal');
            } else {
                showConfirm({
                    title: 'Logout',
                    icon: 'üëã',
                    message: 'Are you sure you want to logout?',
                    confirmText: 'Logout',
                    confirmClass: 'btn-primary',
                    onConfirm: performLogout
                });
            }
        }

        function performLogout() {
            localStorage.removeItem('flashcardUserSession');
            sessionStorage.removeItem('flashcardGuestSession');
            sessionStorage.removeItem('flashcardApp_guest');
            currentUser = null;
            showLoginScreen();
            
            // Clear form fields
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            
            // Close any open modals
            closeModal('guestLogoutModal');
        }

        function deleteAccount() {
            const email = document.getElementById('forgotPasswordEmail').value.trim();
            
            if (!email) {
                showError('Please enter your email address');
                return;
            }
            
            // Get users from localStorage
            const users = JSON.parse(localStorage.getItem('flashcardUsers') || '{}');
            
            if (!users[email]) {
                showError('No account found with this email address');
                return;
            }
            
            // Close the forgot password modal first
            closeModal('forgotPasswordModal');
            
            // Show confirmation modal
            showConfirm({
                title: 'Delete Account',
                icon: 'üóëÔ∏è',
                message: `Are you sure you want to permanently delete the account for <strong>${email}</strong>?`,
                details: `<strong>‚ö†Ô∏è This action cannot be undone!</strong><br><br>This will delete:<br>‚Ä¢ Your account<br>‚Ä¢ All flashcards<br>‚Ä¢ All decks and folders<br>‚Ä¢ All progress and stats`,
                confirmText: 'Delete Account',
                confirmClass: 'btn-danger',
                onConfirm: function() {
                    // Delete user account
                    delete users[email];
                    localStorage.setItem('flashcardUsers', JSON.stringify(users));
                    
                    // Delete user data
                    localStorage.removeItem('flashcardApp_' + email);
                    
                    // Clear input
                    document.getElementById('forgotPasswordEmail').value = '';
                    
                    showSuccess('Account deleted successfully. You can now create a new account.');
                    
                    // Switch to signup tab
                    setTimeout(() => {
                        switchLoginTab('signup');
                    }, 2000);
                }
            });
        }

        function continueAsGuest() {
            openModal('guestWarningModal');
        }

        function confirmGuestMode() {
            currentUser = { 
                email: 'guest', 
                name: 'Guest User',
                isGuest: true 
            };
            
            // Set guest session (but don't persist it)
            sessionStorage.setItem('flashcardGuestSession', JSON.stringify(currentUser));
            
            closeModal('guestWarningModal');
            showMainApp();
        }

        // Initialize app
        function initApp() {
            loadData();
            renderLibrary();
            updateFolderSelects();
            updateDeckSelects();
            renderStats();
            updateSettingsUI();
            setupKeyboardShortcuts();
        }

        // Keyboard Shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Don't trigger shortcuts when typing in input fields
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    return;
                }

                // Navigation shortcuts
                if (e.key >= '1' && e.key <= '5') {
                    const views = ['home', 'study', 'test', 'stats', 'settings'];
                    const viewIndex = parseInt(e.key) - 1;
                    showView(views[viewIndex]);
                    e.preventDefault();
                }

                // Study mode shortcuts
                if (currentView === 'study' && studyCards.length > 0) {
                    if (e.key === ' ' || e.key === 'Spacebar') {
                        flipCard();
                        e.preventDefault();
                    } else if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                        nextCard();
                        e.preventDefault();
                    } else if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                        prevCard();
                        e.preventDefault();
                    } else if (e.key === 'Escape') {
                        endStudy();
                        e.preventDefault();
                    }
                }

                // General shortcuts
                if (e.key === '?' || (e.shiftKey && e.key === '/')) {
                    openModal('keyboardModal');
                    e.preventDefault();
                }
            });
        }

        // Data persistence
        function saveData() {
            if (currentUser) {
                if (currentUser.isGuest) {
                    // For guest users, save to sessionStorage only (temporary)
                    sessionStorage.setItem('flashcardApp_guest', JSON.stringify(appData));
                } else {
                    // For logged-in users, save to localStorage (persistent)
                    localStorage.setItem('flashcardApp_' + currentUser.email, JSON.stringify(appData));
                }
            }
        }

        function loadData() {
            if (currentUser) {
                let saved;
                if (currentUser.isGuest) {
                    // Load from sessionStorage for guest
                    saved = sessionStorage.getItem('flashcardApp_guest');
                } else {
                    // Load from localStorage for logged-in user
                    saved = localStorage.getItem('flashcardApp_' + currentUser.email);
                }
                
                if (saved) {
                    appData = JSON.parse(saved);
                }
            }
        }

        // View Management
        function showView(viewName) {
            currentView = viewName;
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            
            document.getElementById(viewName + 'View').classList.add('active');
            document.querySelector(`[data-view="${viewName}"]`).classList.add('active');
            
            if (viewName === 'stats') {
                renderStats();
            }
            
            if (viewName === 'settings') {
                // Show guest warning banner if in guest mode
                const guestBanner = document.getElementById('guestWarningBanner');
                if (currentUser && currentUser.isGuest) {
                    guestBanner.style.display = 'block';
                } else {
                    guestBanner.style.display = 'none';
                }
            }
        }

        // Modal Management
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Folder Management
        function createFolder() {
            const name = document.getElementById('folderName').value.trim();
            const parent = document.getElementById('folderParent').value || null;
            const colorInputs = document.querySelectorAll('input[name="folderColor"]');
            let color = '#3498db';
            colorInputs.forEach(input => {
                if (input.checked) color = input.value;
            });

            if (!name) {
                alert('Please enter a folder name');
                return;
            }

            const folder = {
                id: Date.now(),
                name: name,
                parent: parent ? parseInt(parent) : null,
                color: color
            };

            appData.folders.push(folder);
            saveData();
            renderLibrary();
            updateFolderSelects();
            closeModal('folderModal');
            
            // Clear form
            document.getElementById('folderName').value = '';
            document.getElementById('folderParent').value = '';
            // Reset to first color
            document.querySelectorAll('input[name="folderColor"]')[0].checked = true;
        }

        // Deck Management
        function createDeck() {
            const name = document.getElementById('deckName').value.trim();
            const folder = document.getElementById('deckFolder').value || null;

            if (!name) {
                alert('Please enter a deck name');
                return;
            }

            const deck = {
                id: Date.now(),
                name: name,
                folder: folder ? parseInt(folder) : null
            };

            appData.decks.push(deck);
            saveData();
            renderLibrary();
            updateDeckSelects();
            closeModal('deckModal');
            
            // Clear form
            document.getElementById('deckName').value = '';
            document.getElementById('deckFolder').value = '';
        }

        // Card Management
        function addCard() {
            const deckId = document.getElementById('cardDeck').value;
            const front = document.getElementById('cardFront').value.trim();
            const back = document.getElementById('cardBack').value.trim();

            if (!deckId || !front || !back) {
                alert('Please fill in all fields');
                return;
            }

            const card = {
                id: Date.now(),
                deck: parseInt(deckId),
                front: front,
                back: back,
                created: new Date().toISOString()
            };

            appData.cards.push(card);
            saveData();
            renderLibrary();
            clearCardForm();
            alert('Card added successfully!');
        }

        function clearCardForm() {
            document.getElementById('cardFront').value = '';
            document.getElementById('cardBack').value = '';
        }

        function toggleAddCardForm() {
            const form = document.getElementById('addCardForm');
            const btn = document.getElementById('addCardToggleBtn');
            
            if (form.style.display === 'none') {
                form.style.display = 'block';
                btn.textContent = '‚úï Close Add Card';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            } else {
                form.style.display = 'none';
                btn.textContent = '‚ûï Add New Card';
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary');
            }
        }

        // Library Rendering
        function renderLibrary() {
            const tree = document.getElementById('folderTree');
            tree.innerHTML = '';

            function renderFolder(parentId, indent = 0) {
                const folders = appData.folders.filter(f => f.parent === parentId);
                const decks = appData.decks.filter(d => d.folder === parentId);

                folders.forEach(folder => {
                    const folderDiv = document.createElement('div');
                    folderDiv.style.marginLeft = `${indent * 30}px`;
                    
                    const cardCount = getCardCountInFolder(folder.id);
                    const hasChildren = appData.folders.some(f => f.parent === folder.id) || 
                                       appData.decks.some(d => d.folder === folder.id);
                    const isCollapsed = collapsedFolders[folder.id] || false;
                    
                    const folderItem = document.createElement('div');
                    folderItem.className = 'folder-item';
                    folderItem.innerHTML = `
                        ${hasChildren ? `<span class="folder-collapse-icon ${isCollapsed ? 'collapsed' : ''}" onclick="toggleFolder(${folder.id}, event)">‚ñº</span>` : '<span style="width: 16px;"></span>'}
                        <div class="folder-item-color" style="background: ${folder.color}"></div>
                        <div class="folder-item-content" onclick="selectFolder(${folder.id}, event)" style="cursor: pointer;">
                            <strong>üìÅ ${folder.name}</strong>
                            <div style="font-size: 0.85em; color: var(--text-secondary);">${cardCount} cards</div>
                        </div>
                        <div class="folder-item-actions">
                            <button class="icon-btn delete" onclick="deleteFolder(${folder.id}, event)">Delete</button>
                        </div>
                    `;
                    folderDiv.appendChild(folderItem);
                    
                    if (hasChildren) {
                        const childrenDiv = document.createElement('div');
                        childrenDiv.className = 'folder-children';
                        childrenDiv.id = 'folder-children-' + folder.id;
                        if (isCollapsed) {
                            childrenDiv.classList.add('collapsed');
                            childrenDiv.style.maxHeight = '0';
                        } else {
                            childrenDiv.style.maxHeight = 'none';
                        }
                        folderDiv.appendChild(childrenDiv);
                    }
                    
                    tree.appendChild(folderDiv);
                    
                    if (hasChildren && !isCollapsed) {
                        const childrenContainer = document.getElementById('folder-children-' + folder.id);
                        const tempDiv = document.createElement('div');
                        renderFolderIntoContainer(folder.id, indent + 1, tempDiv);
                        childrenContainer.innerHTML = tempDiv.innerHTML;
                    }
                });

                decks.forEach(deck => {
                    const deckDiv = document.createElement('div');
                    deckDiv.className = 'folder-item';
                    deckDiv.style.marginLeft = `${indent * 30}px`;
                    
                    const cardCount = appData.cards.filter(c => c.deck === deck.id).length;
                    
                    deckDiv.innerHTML = `
                        <div style="width: 16px;"></div>
                        <div style="width: 24px;">üé¥</div>
                        <div class="folder-item-content">
                            <strong>${deck.name}</strong>
                            <div style="font-size: 0.85em; color: var(--text-secondary);">${cardCount} cards</div>
                        </div>
                        <div class="folder-item-actions">
                            <button class="icon-btn" onclick="manageDeckCards(${deck.id}, event)">View</button>
                            <button class="icon-btn delete" onclick="deleteDeck(${deck.id}, event)">Delete</button>
                        </div>
                    `;
                    tree.appendChild(deckDiv);
                });
            }

            function renderFolderIntoContainer(parentId, indent, container) {
                const folders = appData.folders.filter(f => f.parent === parentId);
                const decks = appData.decks.filter(d => d.folder === parentId);

                folders.forEach(folder => {
                    const folderDiv = document.createElement('div');
                    folderDiv.style.marginLeft = `${indent * 30}px`;
                    
                    const cardCount = getCardCountInFolder(folder.id);
                    const hasChildren = appData.folders.some(f => f.parent === folder.id) || 
                                       appData.decks.some(d => d.folder === folder.id);
                    const isCollapsed = collapsedFolders[folder.id] || false;
                    
                    const folderItem = document.createElement('div');
                    folderItem.className = 'folder-item';
                    folderItem.innerHTML = `
                        ${hasChildren ? `<span class="folder-collapse-icon ${isCollapsed ? 'collapsed' : ''}" onclick="toggleFolder(${folder.id}, event)">‚ñº</span>` : '<span style="width: 16px;"></span>'}
                        <div class="folder-item-color" style="background: ${folder.color}"></div>
                        <div class="folder-item-content" onclick="selectFolder(${folder.id}, event)" style="cursor: pointer;">
                            <strong>üìÅ ${folder.name}</strong>
                            <div style="font-size: 0.85em; color: var(--text-secondary);">${cardCount} cards</div>
                        </div>
                        <div class="folder-item-actions">
                            <button class="icon-btn delete" onclick="deleteFolder(${folder.id}, event)">Delete</button>
                        </div>
                    `;
                    folderDiv.appendChild(folderItem);
                    
                    if (hasChildren) {
                        const childrenDiv = document.createElement('div');
                        childrenDiv.className = 'folder-children';
                        childrenDiv.id = 'folder-children-' + folder.id;
                        if (isCollapsed) {
                            childrenDiv.classList.add('collapsed');
                            childrenDiv.style.maxHeight = '0';
                        } else {
                            childrenDiv.style.maxHeight = 'none';
                        }
                        folderDiv.appendChild(childrenDiv);
                    }
                    
                    container.appendChild(folderDiv);
                    
                    if (hasChildren && !isCollapsed) {
                        const childrenContainer = container.querySelector('#folder-children-' + folder.id);
                        renderFolderIntoContainer(folder.id, indent + 1, childrenContainer);
                    }
                });

                decks.forEach(deck => {
                    const deckDiv = document.createElement('div');
                    deckDiv.className = 'folder-item';
                    deckDiv.style.marginLeft = `${indent * 30}px`;
                    
                    const cardCount = appData.cards.filter(c => c.deck === deck.id).length;
                    
                    deckDiv.innerHTML = `
                        <div style="width: 16px;"></div>
                        <div style="width: 24px;">üé¥</div>
                        <div class="folder-item-content">
                            <strong>${deck.name}</strong>
                            <div style="font-size: 0.85em; color: var(--text-secondary);">${cardCount} cards</div>
                        </div>
                        <div class="folder-item-actions">
                            <button class="icon-btn" onclick="manageDeckCards(${deck.id}, event)">View</button>
                            <button class="icon-btn delete" onclick="deleteDeck(${deck.id}, event)">Delete</button>
                        </div>
                    `;
                    container.appendChild(deckDiv);
                });
            }

            renderFolder(null);
        }

        function selectFolder(folderId, event) {
            if (event) {
                event.stopPropagation();
            }
            
            // Remove selected class from all folders
            document.querySelectorAll('.folder-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Add selected class to clicked folder
            event.target.closest('.folder-item').classList.add('selected');
        }

        function openFolderContents(folderId, event) {
            if (event) {
                event.stopPropagation();
            }
            
            const folder = appData.folders.find(f => f.id === folderId);
            if (!folder) return;
            
            // Store current folder ID for creating subfolders/decks
            window.currentParentFolderId = folderId;
            
            // Get all contents recursively
            function getAllFolderContents(parentId) {
                let contents = {
                    folders: [],
                    decks: [],
                    cards: []
                };
                
                // Get direct subfolders
                const subfolders = appData.folders.filter(f => f.parent === parentId);
                contents.folders = contents.folders.concat(subfolders);
                
                // Get contents of subfolders recursively
                subfolders.forEach(sf => {
                    const subContents = getAllFolderContents(sf.id);
                    contents.folders = contents.folders.concat(subContents.folders);
                    contents.decks = contents.decks.concat(subContents.decks);
                    contents.cards = contents.cards.concat(subContents.cards);
                });
                
                // Get direct decks
                const decks = appData.decks.filter(d => d.folder === parentId);
                contents.decks = contents.decks.concat(decks);
                
                // Get cards from decks
                decks.forEach(deck => {
                    const deckCards = appData.cards.filter(c => c.deck === deck.id);
                    contents.cards = contents.cards.concat(deckCards);
                });
                
                return contents;
            }
            
            const contents = getAllFolderContents(folderId);
            
            // Display in modal
            const modal = document.getElementById('folderContentsModal');
            const container = document.getElementById('folderContentsList');
            
            document.getElementById('folderContentsTitle').textContent = folder.name;
            
            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: var(--text-primary); margin-bottom: 12px;">Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 1.5em; font-weight: 600; color: #667eea;">${contents.folders.length}</div>
                            <div style="font-size: 0.85em; color: var(--text-secondary);">Subfolders</div>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 1.5em; font-weight: 600; color: #f093fb;">${contents.decks.length}</div>
                            <div style="font-size: 0.85em; color: var(--text-secondary);">Decks</div>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 1.5em; font-weight: 600; color: #43e97b;">${contents.cards.length}</div>
                            <div style="font-size: 0.85em; color: var(--text-secondary);">Cards</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="createSubfolderInFolder(${folderId})">‚ûï New Subfolder</button>
                    <button class="btn btn-primary" onclick="createDeckInFolder(${folderId})">‚ûï New Deck</button>
                </div>
            `;
            
            // Show subfolders
            if (contents.folders.length > 0) {
                const foldersSection = document.createElement('div');
                foldersSection.style.marginBottom = '20px';
                foldersSection.innerHTML = '<h4 style="color: var(--text-primary); margin-bottom: 12px;">üìÅ Subfolders</h4>';
                
                contents.folders.forEach(sf => {
                    const cardCount = getCardCountInFolder(sf.id);
                    const folderDiv = document.createElement('div');
                    folderDiv.className = 'card-manage-item';
                    folderDiv.innerHTML = `
                        <div class="card-manage-content">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="folder-item-color" style="background: ${sf.color}; width: 16px; height: 16px; border-radius: 8px;"></div>
                                <strong>${sf.name}</strong>
                            </div>
                            <div style="font-size: 0.85em; color: var(--text-secondary);">${cardCount} cards</div>
                        </div>
                        <button class="btn btn-danger btn-small" onclick="deleteFolderFromModal(${sf.id})">Delete</button>
                    `;
                    foldersSection.appendChild(folderDiv);
                });
                
                container.appendChild(foldersSection);
            }
            
            // Show decks
            if (contents.decks.length > 0) {
                const decksSection = document.createElement('div');
                decksSection.style.marginBottom = '20px';
                decksSection.innerHTML = '<h4 style="color: var(--text-primary); margin-bottom: 12px;">üé¥ Decks</h4>';
                
                contents.decks.forEach(deck => {
                    const cardCount = appData.cards.filter(c => c.deck === deck.id).length;
                    const deckDiv = document.createElement('div');
                    deckDiv.className = 'card-manage-item';
                    deckDiv.innerHTML = `
                        <div class="card-manage-content">
                            <div><strong>${deck.name}</strong></div>
                            <div style="font-size: 0.85em; color: var(--text-secondary);">${cardCount} cards</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary btn-small" onclick="manageDeckCards(${deck.id})">Manage</button>
                            <button class="btn btn-danger btn-small" onclick="deleteDeckFromModal(${deck.id})">Delete</button>
                        </div>
                    `;
                    decksSection.appendChild(deckDiv);
                });
                
                container.appendChild(decksSection);
            }
            
            if (contents.folders.length === 0 && contents.decks.length === 0) {
                container.innerHTML += '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">This folder is empty. Create a subfolder or deck to get started!</p>';
            }
            
            openModal('folderContentsModal');
        }

        function createSubfolderInFolder(parentId) {
            // Pre-fill parent folder in the modal
            document.getElementById('folderParent').value = parentId;
            closeModal('folderContentsModal');
            openModal('folderModal');
        }

        function createDeckInFolder(parentId) {
            // Pre-fill parent folder in the modal
            document.getElementById('deckFolder').value = parentId;
            closeModal('folderContentsModal');
            openModal('deckModal');
        }

        function deleteFolderFromModal(folderId) {
            const folder = appData.folders.find(f => f.id === folderId);
            if (!folder) return;
            
            // Store parent folder info before deletion
            const parentFolderId = window.currentParentFolderId;
            
            // Count all items that will be deleted
            function countFolderContents(parentId) {
                let folderCount = 0;
                let deckCount = 0;
                let cardCount = 0;
                
                const subfolders = appData.folders.filter(f => f.parent === parentId);
                folderCount += subfolders.length;
                
                subfolders.forEach(sf => {
                    const subCounts = countFolderContents(sf.id);
                    folderCount += subCounts.folders;
                    deckCount += subCounts.decks;
                    cardCount += subCounts.cards;
                });
                
                const decks = appData.decks.filter(d => d.folder === parentId);
                deckCount += decks.length;
                
                decks.forEach(deck => {
                    cardCount += appData.cards.filter(c => c.deck === deck.id).length;
                });
                
                return { folders: folderCount, decks: deckCount, cards: cardCount };
            }
            
            const counts = countFolderContents(folderId);
            
            showConfirm({
                title: 'Delete Folder',
                icon: 'üóëÔ∏è',
                message: `Delete folder <strong>"${folder.name}"</strong>?`,
                details: `<strong>This will also delete:</strong><br>‚Ä¢ ${counts.folders} subfolder(s)<br>‚Ä¢ ${counts.decks} deck(s)<br>‚Ä¢ ${counts.cards} card(s)`,
                confirmText: 'Delete Folder',
                confirmClass: 'btn-danger',
                onConfirm: function() {
                    // Delete the folder
                    performDeleteFolder(folderId);
                    
                    // Refresh the modal if parent folder still exists
                    const parentFolder = appData.folders.find(f => f.id === parentFolderId);
                    if (parentFolder) {
                        openFolderContents(parentFolderId, null);
                    } else {
                        closeModal('folderContentsModal');
                    }
                }
            });
        }

        function deleteDeckFromModal(deckId) {
            const deck = appData.decks.find(d => d.id === deckId);
            if (!deck) return;
            
            const cardCount = appData.cards.filter(c => c.deck === deckId).length;
            const parentFolderId = window.currentParentFolderId;
            
            showConfirm({
                title: 'Delete Deck',
                icon: 'üóëÔ∏è',
                message: `Delete deck <strong>"${deck.name}"</strong>?`,
                details: `This will permanently delete <strong>${cardCount} card(s)</strong> inside this deck.`,
                confirmText: 'Delete Deck',
                confirmClass: 'btn-danger',
                onConfirm: function() {
                    // Delete the deck
                    performDeleteDeck(deckId);
                    
                    // Refresh the modal if parent folder still exists
                    const parentFolder = appData.folders.find(f => f.id === parentFolderId);
                    if (parentFolder) {
                        openFolderContents(parentFolderId, null);
                    } else {
                        closeModal('folderContentsModal');
                    }
                }
            });
        }

        function toggleFolder(folderId, event) {
            event.stopPropagation();
            
            collapsedFolders[folderId] = !collapsedFolders[folderId];
            const childrenDiv = document.getElementById('folder-children-' + folderId);
            const icon = event.target;
            
            if (collapsedFolders[folderId]) {
                childrenDiv.classList.add('collapsed');
                childrenDiv.style.maxHeight = '0';
                icon.classList.add('collapsed');
            } else {
                childrenDiv.classList.remove('collapsed');
                childrenDiv.style.maxHeight = childrenDiv.scrollHeight + 'px';
                icon.classList.remove('collapsed');
                
                // Set to none after animation
                setTimeout(() => {
                    if (!collapsedFolders[folderId]) {
                        childrenDiv.style.maxHeight = 'none';
                    }
                }, 300);
            }
        }

        function getCardCountInFolder(folderId) {
            let count = 0;
            
            // Count cards in decks directly in this folder
            const decks = appData.decks.filter(d => d.folder === folderId);
            decks.forEach(deck => {
                count += appData.cards.filter(c => c.deck === deck.id).length;
            });
            
            // Count cards in subfolders
            const subfolders = appData.folders.filter(f => f.parent === folderId);
            subfolders.forEach(subfolder => {
                count += getCardCountInFolder(subfolder.id);
            });
            
            return count;
        }

        // Study Mode with Multi-Deck Support
        function openStudyDeckSelector() {
            const modal = document.getElementById('studyDeckSelectorModal');
            const container = document.getElementById('studyDeckCheckboxList');
            container.innerHTML = '';

            // Group decks by folder
            const decksByFolder = {};
            appData.decks.forEach(deck => {
                const folderId = deck.folder || 'root';
                if (!decksByFolder[folderId]) {
                    decksByFolder[folderId] = [];
                }
                decksByFolder[folderId].push(deck);
            });

            // Render root decks
            if (decksByFolder['root']) {
                const rootGroup = document.createElement('div');
                rootGroup.className = 'folder-group';
                rootGroup.innerHTML = '<div class="folder-group-header">üìÅ Root</div>';
                
                decksByFolder['root'].forEach(deck => {
                    rootGroup.appendChild(createStudyDeckCheckboxItem(deck));
                });
                
                container.appendChild(rootGroup);
            }

            // Render folder decks
            appData.folders.forEach(folder => {
                if (decksByFolder[folder.id] && decksByFolder[folder.id].length > 0) {
                    const folderGroup = document.createElement('div');
                    folderGroup.className = 'folder-group';
                    folderGroup.innerHTML = `<div class="folder-group-header">üìÅ ${folder.name}</div>`;
                    
                    decksByFolder[folder.id].forEach(deck => {
                        folderGroup.appendChild(createStudyDeckCheckboxItem(deck, folder.name));
                    });
                    
                    container.appendChild(folderGroup);
                }
            });

            updateStudySelectionSummary();
            openModal('studyDeckSelectorModal');
        }

        function createStudyDeckCheckboxItem(deck, folderName = 'Root') {
            const cardCount = appData.cards.filter(c => c.deck === deck.id).length;
            
            const item = document.createElement('div');
            item.className = 'deck-checkbox-item';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `study-deck-${deck.id}`;
            checkbox.value = deck.id;
            checkbox.checked = selectedStudyDeckIds.includes(deck.id);
            checkbox.onchange = updateStudySelectionSummary;
            
            item.appendChild(checkbox);
            
            const info = document.createElement('div');
            info.className = 'deck-info';
            info.innerHTML = `
                <div class="deck-name">${deck.name}</div>
                <div class="deck-path">${folderName}</div>
            `;
            item.appendChild(info);
            
            const count = document.createElement('div');
            count.className = 'deck-card-count';
            count.textContent = `${cardCount} cards`;
            item.appendChild(count);
            
            item.onclick = (e) => {
                if (e.target !== checkbox) {
                    checkbox.checked = !checkbox.checked;
                    updateStudySelectionSummary();
                }
            };
            
            return item;
        }

        function updateStudySelectionSummary() {
            const checkboxes = document.querySelectorAll('#studyDeckCheckboxList input[type="checkbox"]:checked');
            const count = checkboxes.length;
            
            let totalCards = 0;
            checkboxes.forEach(cb => {
                const deckId = parseInt(cb.value);
                totalCards += appData.cards.filter(c => c.deck === deckId).length;
            });
            
            const summary = document.getElementById('studySelectionSummary');
            if (count === 0) {
                summary.textContent = 'No decks selected';
            } else {
                summary.textContent = `${count} deck${count > 1 ? 's' : ''} selected ‚Ä¢ ${totalCards} total cards`;
            }
        }

        function startStudyWithSelectedDecks() {
            const checkboxes = document.querySelectorAll('#studyDeckCheckboxList input[type="checkbox"]:checked');
            selectedStudyDeckIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (selectedStudyDeckIds.length === 0) {
                alert('Please select at least one deck');
                return;
            }
            
            closeModal('studyDeckSelectorModal');
            startStudy();
        }

        function startStudy() {
            if (selectedStudyDeckIds.length === 0) {
                openStudyDeckSelector();
                return;
            }

            // Update info display
            const deckNames = selectedStudyDeckIds.map(id => {
                const deck = appData.decks.find(d => d.id === id);
                return deck ? deck.name : '';
            }).filter(Boolean);
            
            document.getElementById('selectedStudyDecksInfo').innerHTML = `
                <strong>Studying:</strong> ${deckNames.join(', ')}
            `;

            // Collect cards from selected decks
            studyCards = [];
            selectedStudyDeckIds.forEach(deckId => {
                const deckCards = appData.cards.filter(c => c.deck === deckId);
                studyCards = studyCards.concat(deckCards);
            });

            if (studyCards.length === 0) {
                alert('Selected decks have no cards!');
                return;
            }

            if (appData.settings.shuffle) {
                studyCards = shuffleArray(studyCards);
            }

            currentCardIndex = 0;
            isFlipped = false;
            document.getElementById('studyArea').style.display = 'block';
            showCard();
            appData.stats.totalStudySessions++;
            saveData();
        }

        function showCard() {
            if (studyCards.length === 0) return;

            const card = studyCards[currentCardIndex];
            const flashcard = document.getElementById('flashcard');
            
            // Add flip animation
            flashcard.classList.add('flipping');
            
            // Remove animation class after it completes
            setTimeout(() => {
                flashcard.classList.remove('flipping');
            }, 600);
            
            // Apply random color
            const colorClass = 'color-' + ((currentCardIndex % 8) + 1);
            flashcard.className = 'flashcard ' + colorClass;
            
            document.getElementById('flashcardContent').textContent = isFlipped ? card.back : card.front;
            document.getElementById('sideIndicator').textContent = isFlipped ? 'Back' : 'Front';
            
            const progress = ((currentCardIndex + 1) / studyCards.length) * 100;
            document.getElementById('studyProgress').style.width = progress + '%';
        }

        function flipCard() {
            if (studyCards.length === 0) return;
            
            const flashcard = document.getElementById('flashcard');
            flashcard.classList.add('flipping');
            
            setTimeout(() => {
                flashcard.classList.remove('flipping');
            }, 600);
            
            isFlipped = !isFlipped;
            
            // Update content in the middle of the flip animation
            setTimeout(() => {
                const card = studyCards[currentCardIndex];
                document.getElementById('flashcardContent').textContent = isFlipped ? card.back : card.front;
                document.getElementById('sideIndicator').textContent = isFlipped ? 'Back' : 'Front';
            }, 300);
        }

        function nextCard() {
            if (studyCards.length === 0) return;
            
            if (currentCardIndex < studyCards.length - 1) {
                currentCardIndex++;
                isFlipped = false;
                showCard();
                appData.stats.totalCardsStudied++;
                saveData();
            } else {
                showConfirm({
                    title: 'Study Complete!',
                    icon: 'üéâ',
                    message: 'Congratulations! You\'ve completed all cards in this deck.',
                    details: 'Would you like to start over and study them again?',
                    confirmText: 'Start Over',
                    confirmClass: 'btn-primary',
                    onConfirm: function() {
                        currentCardIndex = 0;
                        isFlipped = false;
                        if (appData.settings.shuffle) {
                            studyCards = shuffleArray(studyCards);
                        }
                        showCard();
                    }
                });
            }
        }

        function prevCard() {
            if (studyCards.length === 0) return;
            
            if (currentCardIndex > 0) {
                currentCardIndex--;
                isFlipped = false;
                showCard();
            }
        }

        function endStudy() {
            document.getElementById('studyArea').style.display = 'none';
            document.getElementById('selectedStudyDecksInfo').innerHTML = '';
            studyCards = [];
        }

        // Test Mode with Multi-Deck Support
        function openDeckSelector() {
            const modal = document.getElementById('deckSelectorModal');
            const container = document.getElementById('deckCheckboxList');
            container.innerHTML = '';

            // Group decks by folder
            const decksByFolder = {};
            appData.decks.forEach(deck => {
                const folderId = deck.folder || 'root';
                if (!decksByFolder[folderId]) {
                    decksByFolder[folderId] = [];
                }
                decksByFolder[folderId].push(deck);
            });

            // Render root decks
            if (decksByFolder['root']) {
                const rootGroup = document.createElement('div');
                rootGroup.className = 'folder-group';
                rootGroup.innerHTML = '<div class="folder-group-header">üìÅ Root</div>';
                
                decksByFolder['root'].forEach(deck => {
                    rootGroup.appendChild(createDeckCheckboxItem(deck));
                });
                
                container.appendChild(rootGroup);
            }

            // Render folder decks
            appData.folders.forEach(folder => {
                if (decksByFolder[folder.id] && decksByFolder[folder.id].length > 0) {
                    const folderGroup = document.createElement('div');
                    folderGroup.className = 'folder-group';
                    folderGroup.innerHTML = `<div class="folder-group-header">üìÅ ${folder.name}</div>`;
                    
                    decksByFolder[folder.id].forEach(deck => {
                        folderGroup.appendChild(createDeckCheckboxItem(deck, folder.name));
                    });
                    
                    container.appendChild(folderGroup);
                }
            });

            updateSelectionSummary();
            openModal('deckSelectorModal');
        }

        function createDeckCheckboxItem(deck, folderName = 'Root') {
            const cardCount = appData.cards.filter(c => c.deck === deck.id).length;
            
            const item = document.createElement('div');
            item.className = 'deck-checkbox-item';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `deck-${deck.id}`;
            checkbox.value = deck.id;
            checkbox.checked = selectedTestDeckIds.includes(deck.id);
            checkbox.onchange = updateSelectionSummary;
            
            item.appendChild(checkbox);
            
            const info = document.createElement('div');
            info.className = 'deck-info';
            info.innerHTML = `
                <div class="deck-name">${deck.name}</div>
                <div class="deck-path">${folderName}</div>
            `;
            item.appendChild(info);
            
            const count = document.createElement('div');
            count.className = 'deck-card-count';
            count.textContent = `${cardCount} cards`;
            item.appendChild(count);
            
            item.onclick = (e) => {
                if (e.target !== checkbox) {
                    checkbox.checked = !checkbox.checked;
                    updateSelectionSummary();
                }
            };
            
            return item;
        }

        function updateSelectionSummary() {
            const checkboxes = document.querySelectorAll('#deckCheckboxList input[type="checkbox"]:checked');
            const count = checkboxes.length;
            
            let totalCards = 0;
            checkboxes.forEach(cb => {
                const deckId = parseInt(cb.value);
                totalCards += appData.cards.filter(c => c.deck === deckId).length;
            });
            
            const summary = document.getElementById('selectionSummary');
            if (count === 0) {
                summary.textContent = 'No decks selected';
            } else {
                summary.textContent = `${count} deck${count > 1 ? 's' : ''} selected ‚Ä¢ ${totalCards} total cards`;
            }
        }

        function startTestWithSelectedDecks() {
            const checkboxes = document.querySelectorAll('#deckCheckboxList input[type="checkbox"]:checked');
            selectedTestDeckIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (selectedTestDeckIds.length === 0) {
                alert('Please select at least one deck');
                return;
            }
            
            closeModal('deckSelectorModal');
            startTest();
        }

        function startTest() {
            if (selectedTestDeckIds.length === 0) {
                openDeckSelector();
                return;
            }

            // Update info display
            const deckNames = selectedTestDeckIds.map(id => {
                const deck = appData.decks.find(d => d.id === id);
                return deck ? deck.name : '';
            }).filter(Boolean);
            
            document.getElementById('selectedDecksInfo').innerHTML = `
                <strong>Testing:</strong> ${deckNames.join(', ')}
            `;

            // Collect cards from selected decks
            let allCards = [];
            selectedTestDeckIds.forEach(deckId => {
                const deckCards = appData.cards.filter(c => c.deck === deckId);
                allCards = allCards.concat(deckCards);
            });

            if (allCards.length === 0) {
                alert('Selected decks have no cards!');
                return;
            }

            // Shuffle and limit
            allCards = shuffleArray(allCards);
            const limit = Math.min(appData.settings.testLimit, allCards.length);
            testQuestions = allCards.slice(0, limit);
            testAnswers = {};

            renderTestQuestions();
            document.getElementById('testArea').style.display = 'block';
            document.getElementById('testResults').style.display = 'none';
            appData.stats.totalTestSessions++;
            saveData();
        }

        function renderTestQuestions() {
            const container = document.getElementById('testArea');
            container.innerHTML = '<h3>Answer the following questions:</h3>';

            testQuestions.forEach((card, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'test-question';
                questionDiv.innerHTML = `
                    <h3>Question ${index + 1}</h3>
                    <p>${card.front}</p>
                    <input type="text" class="test-input" id="answer-${card.id}" placeholder="Type your answer here">
                `;
                container.appendChild(questionDiv);
            });

            const submitBtn = document.createElement('button');
            submitBtn.className = 'btn btn-primary';
            submitBtn.textContent = 'Submit Test';
            submitBtn.onclick = submitTest;
            container.appendChild(submitBtn);
        }

        function submitTest() {
            testQuestions.forEach(card => {
                const input = document.getElementById(`answer-${card.id}`);
                testAnswers[card.id] = input.value.trim();
            });

            gradeTest();
        }

        function gradeTest() {
            let correct = 0;
            let incorrect = 0;

            const resultsContainer = document.getElementById('testResults');
            resultsContainer.innerHTML = '<h3>Test Results</h3>';

            testQuestions.forEach((card, index) => {
                const userAnswer = testAnswers[card.id] || '';
                const isCorrect = userAnswer.toLowerCase() === card.back.toLowerCase();

                if (isCorrect) {
                    correct++;
                    appData.stats.correctAnswers++;
                } else {
                    incorrect++;
                    appData.stats.incorrectAnswers++;
                }

                const resultDiv = document.createElement('div');
                resultDiv.className = `result-item ${isCorrect ? 'correct' : 'incorrect'}`;
                resultDiv.innerHTML = `
                    <div class="result-question">${index + 1}. ${card.front}</div>
                    <div class="result-answer"><strong>Your answer:</strong> ${userAnswer || '(blank)'}</div>
                    ${!isCorrect && appData.settings.showAnswer ? `<div class="result-answer"><strong>Correct answer:</strong> ${card.back}</div>` : ''}
                    ${isCorrect ? '<div class="result-answer" style="color: #27ae60; font-weight: 600;">‚úì Correct</div>' : '<div class="result-answer" style="color: #e74c3c; font-weight: 600;">‚úó Incorrect</div>'}
                `;
                resultsContainer.appendChild(resultDiv);
            });

            const score = Math.round((correct / testQuestions.length) * 100);
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'test-results';
            summaryDiv.style.marginTop = '20px';
            summaryDiv.innerHTML = `
                <h3>Score: ${score}%</h3>
                <p>Correct: ${correct} | Incorrect: ${incorrect}</p>
            `;
            resultsContainer.insertBefore(summaryDiv, resultsContainer.firstChild);

            const retakeBtn = document.createElement('button');
            retakeBtn.className = 'btn btn-primary';
            retakeBtn.textContent = 'Take Another Test';
            retakeBtn.onclick = () => {
                document.getElementById('testResults').style.display = 'none';
                openDeckSelector();
            };
            resultsContainer.appendChild(retakeBtn);

            document.getElementById('testArea').style.display = 'none';
            document.getElementById('testResults').style.display = 'block';
            saveData();
            renderStats();
        }

        // Stats
        function renderStats() {
            const container = document.getElementById('statsGrid');
            const stats = appData.stats;
            
            const totalQuestions = stats.correctAnswers + stats.incorrectAnswers;
            const accuracy = totalQuestions > 0 ? Math.round((stats.correctAnswers / totalQuestions) * 100) : 0;
            
            // Calculate additional stats
            const totalSessions = stats.totalStudySessions + stats.totalTestSessions;
            const avgCardsPerSession = stats.totalStudySessions > 0 ? 
                Math.round(stats.totalCardsStudied / stats.totalStudySessions) : 0;
            
            container.innerHTML = `
                <div class="stat-card stat-color-1">
                    <div class="stat-value">${appData.cards.length}</div>
                    <div class="stat-label">Total Cards</div>
                </div>
                <div class="stat-card stat-color-2">
                    <div class="stat-value">${appData.decks.length}</div>
                    <div class="stat-label">Total Decks</div>
                </div>
                <div class="stat-card stat-color-3">
                    <div class="stat-value">${stats.totalStudySessions}</div>
                    <div class="stat-label">Study Sessions</div>
                </div>
                <div class="stat-card stat-color-4">
                    <div class="stat-value">${stats.totalTestSessions}</div>
                    <div class="stat-label">Tests Taken</div>
                </div>
                <div class="stat-card stat-color-5">
                    <div class="stat-value">${stats.correctAnswers}</div>
                    <div class="stat-label">Correct Answers</div>
                </div>
                <div class="stat-card stat-color-6">
                    <div class="stat-value">${accuracy}%</div>
                    <div class="stat-label">Accuracy</div>
                </div>
            `;
            
            // Recent Activity
            const activityContainer = document.getElementById('recentActivity');
            if (totalSessions === 0) {
                activityContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">No activity yet. Start studying to see your progress!</p>';
            } else {
                activityContainer.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px;">
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 8px;">Total Sessions</div>
                            <div style="font-size: 2em; font-weight: 600; color: var(--text-primary);">${totalSessions}</div>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px;">
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 8px;">Cards Studied</div>
                            <div style="font-size: 2em; font-weight: 600; color: var(--text-primary);">${stats.totalCardsStudied}</div>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px;">
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 8px;">Avg. Cards/Session</div>
                            <div style="font-size: 2em; font-weight: 600; color: var(--text-primary);">${avgCardsPerSession}</div>
                        </div>
                    </div>
                `;
            }
            
            // Performance Breakdown
            const performanceContainer = document.getElementById('performanceBreakdown');
            if (totalQuestions === 0) {
                performanceContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Take a test to see your performance breakdown!</p>';
            } else {
                const incorrectAnswers = stats.incorrectAnswers;
                performanceContainer.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="background: var(--bg-tertiary); padding: 24px; border-radius: 12px;">
                            <h4 style="margin-bottom: 16px; color: var(--text-primary);">Test Performance</h4>
                            <div style="margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: var(--text-secondary);">Correct</span>
                                    <span style="font-weight: 600; color: #27ae60;">${stats.correctAnswers} (${accuracy}%)</span>
                                </div>
                                <div style="background: var(--border-color); height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${accuracy}%; height: 100%; background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);"></div>
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: var(--text-secondary);">Incorrect</span>
                                    <span style="font-weight: 600; color: #e74c3c;">${incorrectAnswers} (${100 - accuracy}%)</span>
                                </div>
                                <div style="background: var(--border-color); height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${100 - accuracy}%; height: 100%; background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: var(--bg-tertiary); padding: 24px; border-radius: 12px;">
                            <h4 style="margin-bottom: 16px; color: var(--text-primary);">Question Stats</h4>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Total Questions</span>
                                    <span style="font-weight: 600;">${totalQuestions}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Questions per Test</span>
                                    <span style="font-weight: 600;">${stats.totalTestSessions > 0 ? Math.round(totalQuestions / stats.totalTestSessions) : 0}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Success Rate</span>
                                    <span style="font-weight: 600; color: ${accuracy >= 70 ? '#27ae60' : accuracy >= 50 ? '#f39c12' : '#e74c3c'};">${accuracy >= 70 ? '‚úì Good' : accuracy >= 50 ? '‚óã Fair' : '‚úó Needs Work'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Study Streaks
            const streaksContainer = document.getElementById('studyStreaks');
            streaksContainer.innerHTML = `
                <div style="background: var(--bg-tertiary); padding: 24px; border-radius: 12px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2.5em; margin-bottom: 8px;">${appData.folders.length}</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary);">Folders Created</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2.5em; margin-bottom: 8px;">${appData.decks.length}</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary);">Decks Created</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2.5em; margin-bottom: 8px;">${appData.cards.length}</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary);">Cards Created</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2.5em; margin-bottom: 8px;">${totalSessions}</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary);">Total Sessions</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Settings
        function updateSettingsUI() {
            document.getElementById('shuffleToggle').classList.toggle('active', appData.settings.shuffle);
            document.getElementById('showAnswerToggle').classList.toggle('active', appData.settings.showAnswer);
            document.getElementById('themeToggle').classList.toggle('active', appData.settings.theme === 'dark');
            document.getElementById('testLimitInput').value = appData.settings.testLimit;
            
            if (appData.settings.theme === 'dark') {
                document.body.classList.add('dark-mode');
            }
        }

        function toggleSetting(setting) {
            appData.settings[setting] = !appData.settings[setting];
            saveData();
            updateSettingsUI();
        }

        function toggleTheme() {
            appData.settings.theme = appData.settings.theme === 'light' ? 'dark' : 'light';
            document.body.classList.toggle('dark-mode');
            saveData();
            updateSettingsUI();
        }

        function updateTestLimit(value) {
            appData.settings.testLimit = parseInt(value);
            saveData();
        }

        function updateFolderSelects() {
            ['folderParent', 'deckFolder'].forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">Root</option>';
                
                function addFolderOptions(parentId, prefix = '') {
                    const folders = appData.folders.filter(f => f.parent === parentId);
                    folders.forEach(folder => {
                        const option = document.createElement('option');
                        option.value = folder.id;
                        option.textContent = prefix + folder.name;
                        select.appendChild(option);
                        addFolderOptions(folder.id, prefix + '  ');
                    });
                }
                
                addFolderOptions(null);
                
                if (currentValue) {
                    select.value = currentValue;
                }
            });
        }

        function updateDeckSelects() {
            const select = document.getElementById('cardDeck');
            select.innerHTML = '';
            
            appData.decks.forEach(deck => {
                const option = document.createElement('option');
                option.value = deck.id;
                option.textContent = deck.name;
                select.appendChild(option);
            });
        }

        // Utility Functions
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // Data Management
        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `flashcards_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    showConfirm({
                        title: 'Import Data',
                        icon: 'üì•',
                        message: 'This will replace <strong>all current data</strong> with the imported data.',
                        details: '<strong>‚ö†Ô∏è Warning:</strong> Your current flashcards, decks, and folders will be replaced.',
                        confirmText: 'Import Data',
                        confirmClass: 'btn-primary',
                        onConfirm: function() {
                            appData = imported;
                            saveData();
                            initApp();
                            
                            showConfirm({
                                title: 'Import Successful',
                                icon: '‚úÖ',
                                message: 'Data imported successfully!',
                                confirmText: 'OK',
                                confirmClass: 'btn-primary',
                                onConfirm: function() {}
                            });
                        }
                    });
                } catch (error) {
                    showConfirm({
                        title: 'Import Error',
                        icon: '‚ùå',
                        message: 'Error importing data. Please check the file format.',
                        details: error.message,
                        confirmText: 'OK',
                        confirmClass: 'btn-secondary',
                        onConfirm: function() {}
                    });
                }
            };
            reader.readAsText(file);
        }

        function deleteFolder(folderId, event) {
            // Prevent event bubbling
            if (event) {
                event.stopPropagation();
            }
            
            const folder = appData.folders.find(f => f.id === folderId);
            if (!folder) return;
            
            // Count all items that will be deleted
            function countFolderContents(parentId) {
                let folderCount = 0;
                let deckCount = 0;
                let cardCount = 0;
                
                const subfolders = appData.folders.filter(f => f.parent === parentId);
                folderCount += subfolders.length;
                
                subfolders.forEach(sf => {
                    const subCounts = countFolderContents(sf.id);
                    folderCount += subCounts.folders;
                    deckCount += subCounts.decks;
                    cardCount += subCounts.cards;
                });
                
                const decks = appData.decks.filter(d => d.folder === parentId);
                deckCount += decks.length;
                
                decks.forEach(deck => {
                    cardCount += appData.cards.filter(c => c.deck === deck.id).length;
                });
                
                return { folders: folderCount, decks: deckCount, cards: cardCount };
            }
            
            const counts = countFolderContents(folderId);
            
            // Only show confirmation if called from main UI (event exists)
            if (event) {
                showConfirm({
                    title: 'Delete Folder',
                    icon: 'üóëÔ∏è',
                    message: `Delete folder <strong>"${folder.name}"</strong>?`,
                    details: `<strong>This will also delete:</strong><br>‚Ä¢ ${counts.folders} subfolder(s)<br>‚Ä¢ ${counts.decks} deck(s)<br>‚Ä¢ ${counts.cards} card(s)`,
                    confirmText: 'Delete Folder',
                    confirmClass: 'btn-danger',
                    onConfirm: function() {
                        performDeleteFolder(folderId);
                    }
                });
            } else {
                performDeleteFolder(folderId);
            }
        }

        function performDeleteFolder(folderId) {
            // Find all subfolders recursively
            function getAllSubfolders(parentId) {
                const subfolders = appData.folders.filter(f => f.parent === parentId);
                let allIds = subfolders.map(f => f.id);
                subfolders.forEach(f => {
                    allIds = allIds.concat(getAllSubfolders(f.id));
                });
                return allIds;
            }
            
            const folderIds = [folderId, ...getAllSubfolders(folderId)];
            
            // Delete all decks in these folders
            folderIds.forEach(id => {
                const decksToDelete = appData.decks.filter(d => d.folder === id);
                decksToDelete.forEach(deck => {
                    // Delete all cards in deck
                    appData.cards = appData.cards.filter(c => c.deck !== deck.id);
                    // Delete deck
                    appData.decks = appData.decks.filter(d => d.id !== deck.id);
                });
            });
            
            // Delete all folders
            appData.folders = appData.folders.filter(f => !folderIds.includes(f.id));
            
            saveData();
            renderLibrary();
            updateFolderSelects();
            updateDeckSelects();
        }

        function deleteDeck(deckId, event) {
            // Prevent event bubbling
            if (event) {
                event.stopPropagation();
            }
            
            const deck = appData.decks.find(d => d.id === deckId);
            if (!deck) return;
            
            const cardCount = appData.cards.filter(c => c.deck === deckId).length;
            
            // Only show confirmation if called from main UI (event exists)
            if (event) {
                showConfirm({
                    title: 'Delete Deck',
                    icon: 'üóëÔ∏è',
                    message: `Delete deck <strong>"${deck.name}"</strong>?`,
                    details: `This will permanently delete <strong>${cardCount} card(s)</strong> inside this deck.`,
                    confirmText: 'Delete Deck',
                    confirmClass: 'btn-danger',
                    onConfirm: function() {
                        performDeleteDeck(deckId);
                    }
                });
            } else {
                performDeleteDeck(deckId);
            }
        }

        function performDeleteDeck(deckId) {
            appData.cards = appData.cards.filter(c => c.deck !== deckId);
            appData.decks = appData.decks.filter(d => d.id !== deckId);
            
            saveData();
            renderLibrary();
            updateDeckSelects();
        }

        function manageDeckCards(deckId, event) {
            if (event) {
                event.stopPropagation();
            }
            
            currentDeck = appData.decks.find(d => d.id === deckId);
            const cards = appData.cards.filter(c => c.deck === deckId);
            
            const modal = document.getElementById('manageCardsModal');
            const container = document.getElementById('manageCardsList');
            
            container.innerHTML = '';
            
            if (cards.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No cards in this deck yet.</p>';
            } else {
                cards.forEach(card => {
                    const div = document.createElement('div');
                    div.className = 'card-manage-item';
                    div.innerHTML = `
                        <div class="card-manage-content">
                            <div><strong>Q:</strong> ${card.front}</div>
                            <div><strong>A:</strong> ${card.back}</div>
                        </div>
                        <button class="btn btn-danger btn-small" onclick="deleteCard(${card.id})">Delete</button>
                    `;
                    container.appendChild(div);
                });
            }
            
            openModal('manageCardsModal');
        }

        function deleteCard(cardId) {
            const card = appData.cards.find(c => c.id === cardId);
            if (!card) return;
            
            showConfirm({
                title: 'Delete Card',
                icon: 'üóëÔ∏è',
                message: 'Delete this flashcard?',
                details: `<strong>Front:</strong> ${card.front}<br><strong>Back:</strong> ${card.back}`,
                confirmText: 'Delete Card',
                confirmClass: 'btn-danger',
                onConfirm: function() {
                    appData.cards = appData.cards.filter(c => c.id !== cardId);
                    saveData();
                    
                    if (currentDeck) {
                        manageDeckCards(currentDeck.id, null);
                    }
                    renderLibrary();
                }
            });
        }

        function clearAllData() {
            showConfirm({
                title: 'Clear All Data',
                icon: '‚ö†Ô∏è',
                message: 'This will delete <strong>ALL</strong> your data!',
                details: '<strong>‚ö†Ô∏è WARNING: This action cannot be undone!</strong><br><br>This will permanently delete:<br>‚Ä¢ All folders<br>‚Ä¢ All decks<br>‚Ä¢ All flashcards<br>‚Ä¢ All stats and progress',
                confirmText: 'Yes, Delete Everything',
                confirmClass: 'btn-danger',
                onConfirm: function() {
                    // Double confirmation for clear all
                    showConfirm({
                        title: 'Final Confirmation',
                        icon: 'üö®',
                        message: 'Are you <strong>absolutely sure</strong>?',
                        details: 'This is your last chance to cancel. All your data will be permanently deleted!',
                        confirmText: 'Delete Everything',
                        confirmClass: 'btn-danger',
                        onConfirm: function() {
                            if (currentUser) {
                                localStorage.removeItem('flashcardApp_' + currentUser.email);
                            }
                            appData = {
                                folders: [],
                                decks: [],
                                cards: [],
                                stats: {
                                    totalStudySessions: 0,
                                    totalTestSessions: 0,
                                    totalCardsStudied: 0,
                                    correctAnswers: 0,
                                    incorrectAnswers: 0
                                },
                                settings: {
                                    autoFlip: false,
                                    shuffle: true,
                                    sound: false,
                                    showAnswer: false,
                                    testLimit: 20,
                                    theme: 'light',
                                    compactMode: false,
                                    animations: true
                                }
                            };
                            saveData();
                            initApp();
                            
                            // Show success modal instead of alert
                            showConfirm({
                                title: 'Data Cleared',
                                icon: '‚úÖ',
                                message: 'All data has been successfully cleared!',
                                confirmText: 'OK',
                                confirmClass: 'btn-primary',
                                onConfirm: function() {}
                            });
                        }
                    });
                }
            });
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Handle color option selection
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('color-option')) {
                document.querySelectorAll('.color-option').forEach(opt => {
                    opt.style.border = '3px solid transparent';
                });
                e.target.style.border = '3px solid #2c3e50';
                const radio = e.target.parentElement.querySelector('input[type="radio"]');
                if (radio) radio.checked = true;
            }
        });

        // Handle Enter key for login forms
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (document.getElementById('loginForm').classList.contains('active')) {
                    handleLogin();
                } else if (document.getElementById('signupForm').classList.contains('active')) {
                    handleSignup();
                }
            }
        });

        // Initialize on load
        window.onload = initAuth;
    </script>
</body>
</html>
